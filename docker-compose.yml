services:
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: mosquitto
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ${MOSQUITTO_CONFIG_DIR:-./mosquitto/config}:/mosquitto/config
      - ${MOSQUITTO_DATA_DIR:-./mosquitto/data}:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    environment:
      - TZ=${TZ:-America/Toronto}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
    networks:
      - zigbee-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "1883"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    mem_limit: 512m
    cpus: 0.5
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  zigbee2mqtt:
    image: koenkk/zigbee2mqtt:latest
    container_name: zigbee2mqtt
    restart: unless-stopped
    volumes:
      - ${DATA_DIR:-./zigbee2mqtt/data}:/app/data
      - ${CONFIG_DIR:-./zigbee2mqtt/config}:/app/config
      - /run/dbus:/run/dbus:ro
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
    ports:
      - "${Z2M_UI_PORT:-8080}:8080"
    environment:
      - TZ=${TZ:-America/Toronto}
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - ZIGBEE2MQTT_CONFIG_MQTT_BASE_TOPIC=${MQTT_BASE_TOPIC:-zigbee2mqtt}
      - ZIGBEE2MQTT_CONFIG_MQTT_SERVER=${MQTT_SERVER:-mqtt://mosquitto:1883}
      - ZIGBEE2MQTT_CONFIG_SERIAL_PORT=tcp://${Z2M_COORDINATOR_ADDR:-slzb-mrw10u.local}:${Z2M_COORDINATOR_PORT:-7638}
      - ZIGBEE2MQTT_CONFIG_SERIAL_ADAPTER=${Z2M_ADAPTER:-zstack}
      - ZIGBEE2MQTT_CONFIG_SERIAL_BAUDRATE=${Z2M_BAUDRATE:-115200}
      - ZIGBEE2MQTT_CONFIG_ADVANCED_CHANNEL=${Z2M_CHANNEL:-11}
      - ZIGBEE2MQTT_CONFIG_ADVANCED_PAN_ID=${Z2M_PAN_ID:-6754}
      - ZIGBEE2MQTT_CONFIG_ADVANCED_EXT_PAN_ID=${Z2M_EXT_PAN_ID:-[221,221,221,221,221,221,221,221]}
      - ZIGBEE2MQTT_CONFIG_ADVANCED_TRANSMIT_POWER=${Z2M_TRANSMIT_POWER:-20}
      - ZIGBEE2MQTT_CONFIG_ADVANCED_LOG_LEVEL=${Z2M_LOG_LEVEL:-info}
      - ZIGBEE2MQTT_CONFIG_PERMIT_JOIN=${Z2M_PERMIT_JOIN:-true}
    depends_on:
      mosquitto:
        condition: service_healthy
    networks:
      - zigbee-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080"]
      interval: 5m
      timeout: 10s
      retries: 3
      start_period: 30s
    mem_limit: 1024m
    cpus: 1.0
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  matter-server:
    image: ghcr.io/home-assistant-libs/python-matter-server:stable
    container_name: matter-server
    restart: unless-stopped
    security_opt:
      - apparmor:unconfined
    volumes:
      - ./matter-server/data:/data
      - /run/dbus:/run/dbus:ro
    network_mode: host
    environment:
      - TZ=${TZ:-America/Toronto}

  otbr:
    image: openthread/otbr:latest
    container_name: otbr
    restart: unless-stopped
    network_mode: host
    privileged: true
    volumes:
      - ./otbr/data:/data
    environment:
      - TZ=${TZ:-America/Toronto}
    command: >
      spinel+tcp://${MATTER_COORDINATOR_ADDR:-slzb-06u.local}:${MATTER_COORDINATOR_PORT:-6638}


networks:
  zigbee-network:
    driver: bridge

